<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Cart - Biji Kopi</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/cart.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
</head>
<body>
    <nav>

    <!-- KIRI: POINTS -->
    <div class="nav-left">
        <span class="points-display">
            ⭐ <%= point %> pts
        </span>
    </div>

    <div class="nav-center">
      <a href="/" class="<%= page === 'main' ? 'active' : '' %>">MAIN</a>
      <a href="/foods" class="<%= page === 'foods' ? 'active' : '' %>">FOODS</a>
      <a href="/drinks" class="<%= page === 'drinks' ? 'active' : '' %>">DRINKS</a>
      <a href="/cart" class="<%= page === 'cart' ? 'active' : '' %>">CART</a>
      <a href="/transactions" class="<%= page === 'history' ? 'active' : '' %>">HISTORY</a>
      <a href="/forum" class="<%= page === 'forum' ? 'active' : '' %>">FORUM</a>
    </div>
    
    <!-- KANAN -->
    <div class="nav-right">
        <span class="logged-as">
            LOGGED AS <%= role === "admin" ? user.fullname_admin : user.fullname_customer %>
        </span>
        <a href="/logout" class="login-btn">LOGOUT</a>
    </div>

</nav>

<div class="container">
    <h1 style="font-family: 'Poppins', sans-serif; padding-top:20px">Your Cart</h1>


    <% if(cart.length === 0){ %>
        <p class="empty-cart">Your cart is currently empty ☕</p>
    <% } else { %>
        <form action="/payment" method="POST" id="checkoutForm">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>Name</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% cart.forEach(item => { %>
                    <tr>
                        <td>
                            <input 
                                type="checkbox" 
                                name="selected[]" 
                                value="<%= item.id_cart %>" 
                                class="item-check" 
                                data-total="<%= item.total_cart %>">
                        </td>
                        <td><%= item.name_cart %></td>
                        <td><%= item.qty_cart %></td>
                        <td>Rp <%= item.total_cart.toLocaleString("id-ID") %></td>
                        <td>
                            <button 
                                formaction="/cart/remove" 
                                formmethod="POST" 
                                name="id_cart" 
                                value="<%= item.id_cart %>" 
                                class="remove-btn" 
                                formnovalidate>
                                Remove
                            </button>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>

            <div class="cart-summary">
                <div class="total-box">
                    <p><strong>Total Items:</strong> <%= cart.length %></p>
                    <p><strong>Total All:</strong> Rp <%= totalPrice.toLocaleString("id-ID") %></p>
                    <p><strong>Total Selected:</strong> <span id="selectedTotal">Rp 0</span></p>
                </div>
            </div>

            <div class="checkout-container">
                <button 
                    type="submit" 
                    name="action" 
                    value="checkout" 
                    class="checkout-btn">
                    Proceed to Checkout
                </button>
            </div>
        </form>
    <% } %>
</div>

<script>
    const selectAll = document.getElementById("selectAll");
    const itemChecks = document.querySelectorAll(".item-check");
    const totalSelected = document.getElementById("selectedTotal");
    const checkoutForm = document.getElementById("checkoutForm");

    function updateSelectedTotal() {
        let sum = 0;
        itemChecks.forEach(chk => {
            if (chk.checked) sum += parseFloat(chk.dataset.total);
        });
        totalSelected.textContent = "Rp " + sum.toLocaleString("id-ID");
    }

    selectAll?.addEventListener("change", () => {
        itemChecks.forEach(chk => chk.checked = selectAll.checked);
        updateSelectedTotal();
    });

    itemChecks.forEach(chk => {
        chk.addEventListener("change", () => {
            selectAll.checked = [...itemChecks].every(c => c.checked);
            updateSelectedTotal();
        });
    });

    checkoutForm?.addEventListener("submit", (e) => {
        // Cek tombol mana yang ditekan
        const isCheckout = e.submitter?.name === "action" && e.submitter.value === "checkout";

        // Jalankan validasi hanya kalau tombol checkout ditekan
        if (isCheckout) {
            const checked = [...itemChecks].some(chk => chk.checked);
            if (!checked) {
                e.preventDefault();
                alert("Pilih minimal 1 item untuk checkout!");
            }
        }
    });
</script>
<script>
    // === CONFIRM REMOVE FROM CART ===
    document.querySelectorAll(".remove-btn").forEach(btn => {
        btn.addEventListener("click", function (e) {
            const confirmDelete = confirm(
                "Are you sure?\nYou want to remove this item from cart?"
            );

            if (!confirmDelete) {
                e.preventDefault(); // ❌ batalkan submit ke /cart/remove
            }
            // kalau YES → form tetap submit normal
        });
    });
</script>
<div class="popup-overlay" id="confirmPopup">
    <div class="popup">
        <h3>Are you sure?</h3>
        <p style="color:#ddd">You want to remove this item from cart</p>

        <div style="margin-top:15px;">
            <button id="confirmYes">Yes</button>
            <button id="confirmNo" style="background:#b71c1c;">Cancel</button>
        </div>
    </div>
</div>
</body>
</html>
