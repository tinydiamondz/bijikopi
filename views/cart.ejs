<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Cart - Biji Kopi</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/cart.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<nav>
    <div class="nav-left">
        <span class="points-display">⭐ <%= point %> pts</span>
    </div>

    <div class="nav-center">
      <a href="/" class="<%= page === 'main' ? 'active' : '' %>">MAIN</a>
      <a href="/foods" class="<%= page === 'foods' ? 'active' : '' %>">FOODS</a>
      <a href="/drinks" class="<%= page === 'drinks' ? 'active' : '' %>">DRINKS</a>
      <a href="/cart" class="<%= page === 'cart' ? 'active' : '' %>">CART</a>
      <a href="/transactions" class="<%= page === 'history' ? 'active' : '' %>">HISTORY</a>
      <a href="/forum" class="<%= page === 'forum' ? 'active' : '' %>">FORUM</a>
    </div>

    <div class="nav-right">
        <span class="logged-as">
            LOGGED AS <%= role === "admin" ? user.fullname_admin : user.fullname_customer %>
        </span>
        <a href="/logout" class="login-btn">LOGOUT</a>
    </div>
</nav>

<div class="container">
    <h1 style="font-family: 'Poppins', sans-serif; padding-top:20px">Your Cart</h1>

    <% if(cart.length === 0){ %>
        <p class="empty-cart">Your cart is currently empty ☕</p>
    <% } else { %>
        <form action="/payment" method="POST" id="checkoutForm">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>Name</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% cart.forEach(item => { %>
                    <tr>
                        <td>
                            <input 
                                type="checkbox" 
                                name="selected[]" 
                                value="<%= item.id_cart %>" 
                                class="item-check" 
                                data-total="<%= item.total_cart %>">
                        </td>
                        <td class="item-name"><%= item.name_cart %></td>
                        <td><%= item.qty_cart %></td>
                        <td>Rp <%= item.total_cart.toLocaleString("id-ID") %></td>
                        <td>
                            <!-- decrement button -->
                            <button 
                                type="button"
                                formaction="/cart/remove" 
                                formmethod="POST" 
                                name="id_cart" 
                                value="<%= item.id_cart %>" 
                                class="remove-btn"  
                                formnovalidate>
                                -
                            </button>
                        
                            <!-- increment button -->
                            <button 
                                type="button" 
                                class="add-btn"   
                                data-id="<%= item.id_cart %>">
                                +
                            </button>
                        </td>

                    </tr>
                    <% }) %>
                </tbody>
            </table>

            <div class="cart-summary">
                <div class="total-box">
                    <p><strong>Total Items:</strong> <%= cart.length %></p>
                    <p><strong>Total All:</strong> Rp <%= totalPrice.toLocaleString("id-ID") %></p>
                    <p><strong>Total Selected:</strong> <span id="selectedTotal">Rp 0</span></p>
                </div>
            </div>

            <div class="checkout-container">
                <button type="submit" name="action" value="checkout" class="checkout-btn">
                    Proceed to Checkout
                </button>
            </div>
        </form>
    <% } %>
</div>

<!-- === POPUP CUSTOM === -->
<div class="popup-overlay" id="confirmPopup">
    <div class="popup">
        <h3>Are you sure?</h3>
        <p id="popupItemName">You want to remove this item from cart</p>
        <div style="margin-top:15px;">
            <button id="confirmYes">Yes</button>
            <button id="confirmNo" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<script>
    // === SELECT ALL & TOTAL SELECTED ===
    const selectAll = document.getElementById("selectAll");
    const itemChecks = document.querySelectorAll(".item-check");
    const totalSelected = document.getElementById("selectedTotal");
    const checkoutForm = document.getElementById("checkoutForm");

    function updateSelectedTotal() {
        let sum = 0;
        itemChecks.forEach(chk => {
            if (chk.checked) sum += parseFloat(chk.dataset.total);
        });
        totalSelected.textContent = "Rp " + sum.toLocaleString("id-ID");
    }

    selectAll?.addEventListener("change", () => {
        itemChecks.forEach(chk => chk.checked = selectAll.checked);
        updateSelectedTotal();
    });

    itemChecks.forEach(chk => {
        chk.addEventListener("change", () => {
            selectAll.checked = [...itemChecks].every(c => c.checked);
            updateSelectedTotal();
        });
    });

    checkoutForm?.addEventListener("submit", (e) => {
        const isCheckout = e.submitter?.name === "action" && e.submitter.value === "checkout";
        if (isCheckout) {
            const checked = [...itemChecks].some(chk => chk.checked);
            if (!checked) {
                e.preventDefault();
                alert("Pilih minimal 1 item untuk checkout!");
            }
        }
    });
</script>

<script>
    // === CONFIRM REMOVE CUSTOM POPUP ===
    const removeBtns = document.querySelectorAll(".remove-btn");
    const popupOverlay = document.getElementById("confirmPopup");
    const confirmYes = document.getElementById("confirmYes");
    const confirmNo = document.getElementById("confirmNo");
    const popupItemName = document.getElementById("popupItemName");

    let selectedBtn = null;

    removeBtns.forEach(btn => {
        btn.addEventListener("click", function(e) {
            e.preventDefault(); // hentikan submit default
            const itemRow = btn.closest("tr");
            const qty = parseInt(itemRow.querySelector("td:nth-child(3)").textContent); // ambil qty

            if(qty > 1){
                // langsung kurangi 1 tanpa popup
                const tempForm = document.createElement("form");
                tempForm.action = btn.getAttribute("formaction");
                tempForm.method = btn.getAttribute("formmethod") || "POST";

                const input = document.createElement("input");
                input.type = "hidden";
                input.name = btn.name;
                input.value = btn.value;
                tempForm.appendChild(input);

                const inputQty = document.createElement("input");
                inputQty.type = "hidden";
                inputQty.name = "decrement"; // backend bisa cek param ini
                inputQty.value = "1";
                tempForm.appendChild(inputQty);

                document.body.appendChild(tempForm);
                tempForm.submit();
            } else {
                // qty = 1 → tampilkan popup
                selectedBtn = btn;
                const itemName = itemRow.querySelector(".item-name").textContent;
                popupItemName.textContent = `You want to remove "${itemName}" from cart`;
                popupOverlay.style.display = "flex";
            }
        });
    });

    confirmYes.addEventListener("click", () => {
        if (selectedBtn) {
            // buat form sementara untuk submit
            const tempForm = document.createElement("form");
            tempForm.action = selectedBtn.getAttribute("formaction");
            tempForm.method = selectedBtn.getAttribute("formmethod") || "POST";
        
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = selectedBtn.name;
            input.value = selectedBtn.value;
            tempForm.appendChild(input);
        
            document.body.appendChild(tempForm);
            tempForm.submit();
        }
        popupOverlay.style.display = "none";
        selectedBtn = null;
    });

    confirmNo.addEventListener("click", () => {
        popupOverlay.style.display = "none";
        selectedBtn = null;
    });

    // === ACTION INCREMENT BUTTON ===
    const addBtns = document.querySelectorAll(".add-btn");

    addBtns.forEach(btn => {
        btn.addEventListener("click", function() {
            const id_cart = btn.dataset.id;
        
            // buat form sementara
            const tempForm = document.createElement("form");
            tempForm.action = "/cart/increment"; // endpoint baru untuk increment
            tempForm.method = "POST";
        
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "id_cart";
            input.value = id_cart;
            tempForm.appendChild(input);
        
            document.body.appendChild(tempForm);
            tempForm.submit();
        });
    });

</script>
<% if (errorStock) { %>
    <!-- Popup Alert -->
    <div class="popup-overlay" id="stockPopup">
        <div class="popup">
            <h3>⚠️ Stok Terbatas!</h3>
            <p>Jumlah yang dipilih melebihi stok tersedia.</p>
            <button onclick="closePopup()">Oke</button>
        </div>
    </div>
<% } %>


<script>
    function closePopup() {
        document.getElementById('stockPopup').style.display = 'none';
    }
    </script>
    <% if (errorStock) { %>
    <script>
        const popup = document.getElementById('stockPopup');
        popup.style.display = 'flex';
    </script>
    <% } %>
</body>
</html>
